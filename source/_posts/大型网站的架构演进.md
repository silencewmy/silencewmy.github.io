---
title: 大型网站的架构演进
date: 2019-03-10 10:42:42
tags: [中间件,架构]
categories: 技术
---


网站如何由小变大


<!--more-->

网站从小型的单机架构遇到瓶颈一步步升级为大型的分布式架构。

大型网站的定义：访问量和数据量，海量的数据加上非常高的并发访问量。

**Java+单机**

数据库和网站项目部署在同一个机器上。各个功能模块之间通过JVM内部的方法调用进行交互，他们都在同一个进程中。

*访问量的增大，单机的响应变慢，单机负载较大。 --数据库和应用分离*

**应用服务器+数据库服务器**

*访问量增大，应用服务器负载告警*

应用服务器的压力增大，可有针对性的进行优化。一种为 **将应用从单机到集群**
而将一台机器变为多台机器，对于系统中要解决的问题有如下两个：

- 用户对多台应用服务器访问的选择问题。-------------DNS或者负载均衡设备。
- session问题。

**什么是session（会话）？**纯属个人理解！！！

产生：使用网络服务的浏览器和服务器之间的多次交互。基于HTTP支持会话状态的机制使得web服务器可以在多次单独的请求中看到会话。  
如何区分请求所属于的会话（多个客户端进行服务请求）。  
**在会话开始时服务器会分配唯一的会话标识，并通过cookie告知客户端。在客户端，要求每次进行请求需要带上会话标识。在服务器上每个会话都有独立的存储，保存不同的数据。**

**session问题就是当服务器由一台增加为多台时，如何保证能够找到请求所属的会话存储的数据。解决方式如下几种：**

- **session sticky**：在负载均衡处做处理，根据请求所带的标识进行请求转发。这种方式和只有一台时一样，服务器只需要根据到来的请求进行处理，因为这些请求的会话数据一定在本地。一个请求对应一个服务器。缺点是当其中一台服务器出问题宕机，则该服务器上的所有的会话数据会丢失。同时在负载均衡设备上进行处理势必会造成负载的内存消耗增加。
- **session replication**：多个服务器进行会话数据的同步。这样就能实现一条请求对应多个服务器，可以进行路由的择优选择。缺点是会造成网络带宽开销。并且每个服务器都要备份应用中全部的会话数据。
- **session集中存储**：session数据不在服务器本地存储，而是集中存储，每个服务器根据标识或者某种算法在集中池中获得数据。
- **cookie Based**：将session数据存储在客户端本地。通过cookie传递session数据，服务器从cookie中生成会话数据。
- 总结：对于大型网站来说，session集中存储和session sticky是比较好的方案。

*数据读压力变大，数据读写分离*

数据量访问量增加，业务大部分都读多写少。此时增加一个数据读库（读库不一定是数据库也可以是能提供读数据的各种读源）只提供读服务。**面临两个问题**

- **数据的复制**（从读写库到读库）：使用数据库的复制，存在复制时延期间数据短期不一致。可以看到数据库对此的支持是有限的。因此推荐使用分布式数据访问层。
- **数据源的选择问题。**增加的是读源，所以解决的是向读源复制数据。
应用根据不同情况选择不同的数据源。写操作走主库，事务中的读操作要走主库

读源

- 搜索引擎： 大型网站的站内搜索功能，就是一个读库。搜索引擎的倒排表方式很大程度提高检索速度。要根据被搜索数据建立索引，
-  缓存 cache 加速数据库读取
-  分布式存储系统 **数据库之外的用于存储——弥补关系型数据库的不足更多的是直接代替主库。**常见的分布式存储系统有
    +  分布式文件系统：**小文件和大文件的存储问题**
    +  分布式key-value系统：**高性能板结构化支持**
    +  分布式数据库：**大数据和高并发的数据库系统**

*读写分离后又遇到瓶颈的数据库*——**所有数据都一个主库中造成压力瓶颈 解决方式为垂直拆分和水平拆分两种选择**

- **垂直拆分**  
    将数据按照业务进行划分，划分结果为同一个数据库中的数据按照业务分成了多个数据库，每个数据库有自己的连接池，并且会导致数据库事务复杂化为业务事务。解决方式为 **使用分布式事务，或者去掉事务或不去追求强事务。**
- **数据量巨大垂直拆分后又会造成瓶颈，将数据水平拆分**  
    **水平拆分就是将同一个表中的数据拆分到不同的数据库中（数量可多个）**  
    造成水平拆分的原因是，某个业务的数据量达到单个数据库的瓶颈  
    **水平拆分后需要解决**
    + 需要SQL路由
    + 主键的处理不同（自增主键不可用）
    + 

####当数据库的问题解决后应用会面对问题####
**伴随着业务发展，应用功能会会越来越多，应用变大需考虑如何不让应用持续变大，也就是在同一个JVM进程中，所有的应用功能线程争抢同一个线程中的资源（重要的是CPU时间），代码量巨大，因此检查代码也是一个问题。解决办法如下**

- **根据业务特性进行应用拆分**例如将不同的功能进行拆分，这要求拆分后的应用之间不存在直接调用（数据如何传递）。**被拆分后不同应用系统之间会存在相似的功能性代码，这就有了代码的一致和复用的问题**拆分后可能连接相同的数据库。
- **另一种是走服务化的路线**，将应用拆分成3层
    + web系统 **来完成不同的业务功能**
    + 服务中心 **提供不同的业务服务**
    + 数据库 **业务的数据库**  
**服务化应用后共享的代码放在了服务中心；  
与数据库的交互放到了服务中心（直接降低数据库的连接数，因为由服务中心来进行数据请求）  
同时引入了远程的服务调用**


